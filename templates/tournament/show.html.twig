{% extends 'base.html.twig' %}

{% block title %}{{ tournament.name }}{% endblock %}

{% block body %}
<section class="tournament-header">
  <div class="tournament-header-inner">
    <div class="tournament-image">
      <img src="{{ tournament.image ? asset('img/tournaments/' ~ tournament.image) : asset('images/tournaments/default.jpg') }}" 
           alt="{{ tournament.name }}">
    </div>

  {% if app.user in tournament.referees %}
    <a href="{{ path('app_tournament_match_new', { tournamentId: tournament.id }) }}" class="btn btn-neon">
        â• CrÃ©er un match
    </a>

{% endif %}
    <div class="tournament-info">
      <h1>{{ tournament.name }}</h1>
      <p class="meta">ğŸ“… {{ tournament.date|date('d/m/Y') }} â€” ğŸ“ {{ tournament.location }}</p>
      <p class="slots">ğŸ® {{ tournament.tournamentParticipants|length }}/{{ tournament.availableSlots }} joueurs inscrits</p>
      <p class="slots">ğŸ‘¨â€âš–ï¸ {{ tournament.referees|length }} arbitre{{ tournament.referees|length > 1 ? 's' : '' }}</p>

      <div class="banner-actions">
        {% if app.user %}
          {% set isRegistered = false %}
          {% for p in tournament.tournamentParticipants %}
            {% if p.user.id == app.user.id %}
              {% set isRegistered = true %}
            {% endif %}
          {% endfor %}

          {% if isRegistered %}
            <button class="btn-joined" disabled>DÃ©jÃ  inscrit âœ…</button>
          {% elseif tournament.tournamentParticipants|length >= tournament.availableSlots %}
            <button class="btn-disabled" disabled>Complet âŒ</button>
          {% else %}
            <a href="{{ path('app_tournament_register', { id: tournament.id }) }}" class="btn-join">Sâ€™inscrire ğŸ”¥</a>
          {% endif %}
        {% else %}
          <a href="{{ path('app_login') }}" class="btn-login-neon">Se connecter</a>
        {% endif %}
      </div>
    </div>
  </div>
</section>

<section class="tournament-participants">
  <h2>ğŸ‘¥ Participants</h2>

  {% if tournament.tournamentParticipants is empty %}
    <p class="empty-text">Aucun joueur inscrit pour le moment.</p>
  {% else %}
    <div class="participants-grid">
      {% for p in tournament.tournamentParticipants %}
    <div class="player-card">
        <div class="player-avatar">
            <img src="{{ asset('img/avatars/' ~ p.user.avatar) }}" alt="Avatar joueur">
        </div>

        <div class="player-info">
            <h3>{{ p.user.pseudo|default(p.user.email) }}</h3>

            {% if app.user and app.user.id == p.user.id %}
                <span class="tag">Moi</span>
            {% endif %}
        </div>

        {# --- BOUTON DÃ‰FIER --- #}
        {% if app.user and app.user.id != p.user.id %}
            <a class="btn-challenge"
               href="{{ path('match_invite_send', {
                    id: tournament.id,
                    opponentId: p.id
               }) }}">
                âš”ï¸ DÃ©fier
            </a>
        {% endif %}

    </div>
{% endfor %}
    </div>
  {% endif %}
</section>
</div>

<div class="tournament-actions">
  {% if app.user %}
    {% if isRegistered %}
      
      <a href="{{ path('app_tournament_shop', { id: tournament.id }) }}" class="btn-shop">ğŸ›’ Boutique du tournoi</a>
    {% elseif tournament.tournamentParticipants|length >= tournament.availableSlots %}
      <button class="btn-disabled">Complet âŒ</button>
    {% else %}
      <a href="{{ path('app_tournament_register', { id: tournament.id }) }}" class="btn-join">Sâ€™inscrire ğŸ”¥</a>
    {% endif %}
  {% else %}
    <a href="{{ path('app_login') }}" class="btn-login-neon">Se connecter</a>
  {% endif %}
  <a href="{{ path('app_tournament_match_index', {tournamentId: tournament.id}) }}" class="btn-matches">ğŸ® Voir les matchs du tournoi</a>
</div>
{% if app.user %}
    {% set myParticipant = tournament.tournamentParticipants|filter(p => p.user.id == app.user.id)|first %}

    {% if myParticipant %}
        {% set invites = myParticipant.matchInvitesReceived|filter(i => i.status == 'pending') %}

        {% if invites is not empty %}
            <div class="invite-box">
                <h3>âš”ï¸ DÃ©fis reÃ§us</h3>

                {% for invite in invites %}
                    <div class="invite-item">
                        <p>{{ invite.challenger.user.email }} vous dÃ©fie !</p>

                        <a class="btn-accept"
                           href="{{ path('match_invite_accept', {inviteId: invite.id}) }}">
                            Accepter
                        </a>

                        <a class="btn-refuse"
                           href="{{ path('match_invite_refuse', {inviteId: invite.id}) }}">
                            Refuser
                        </a>
                    </div>
                {% endfor %}
            </div>
        {% endif %}
    {% endif %}
{% endif %}

<section class="tournament-cards">
  <h2>ğŸ´ Cartes disponibles</h2>

  {% if tournament.tournamentCards is empty %}
    <p class="empty-text">Aucune carte disponible pour ce tournoi.</p>
  {% else %}
    <div class="cards-grid">
      {% for tournamentCard in tournament.tournamentCards %}
        {% set card = tournamentCard.card %}
        <div class="card-element {{ card.element|lower }}">
          <img 
            src="{{ asset('img/cards/' ~ card.image) }}" 
            alt="{{ card.name }}" 
            class="card-img"
          >
          <div class="card-info">
            <h3>{{ card.name }}</h3>
            <p class="bonus">{{ card.effect }}</p>
            {% if card.rank is defined %}
              <p class="rank">Rang : {{ card.rank }}</p>
            {% endif %}
          </div>
        </div>
      {% endfor %}
    </div>
  {% endif %}
</section>
{% endblock %}