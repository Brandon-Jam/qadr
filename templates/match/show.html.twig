{% extends 'base.html.twig' %}

{% block body %}
<section class="match-view">

    {# ------------------------------------- #
       HEADER
    # ------------------------------------- #}

    <h1 class="match-title">
        <span>{{ match.player1.user.pseudo }}</span> vs
        <span>{{ match.player2.user.pseudo }}</span>
    </h1>

    <p class="phase-indicator">
        Phase actuelle : <strong>{{ match.phase|capitalize }}</strong>
    </p>



    {# ------------------------------------------------------------- #
   üî• SCORE / HP
# ------------------------------------------------------------- #}

{% set isP1 = currentParticipant and currentParticipant.id == match.player1.id %}
{% set isP2 = currentParticipant and currentParticipant.id == match.player2.id %}

{% if isP1 %}
    {% set selfName  = match.player1.user.pseudo %}
    {% set selfScore = match.score1 %}
    {% set oppName   = match.player2.user.pseudo %}
    {% set oppScore  = match.score2 %}
{% elseif isP2 %}
    {% set selfName  = match.player2.user.pseudo %}
    {% set selfScore = match.score2 %}
    {% set oppName   = match.player1.user.pseudo %}
    {% set oppScore  = match.score1 %}
{% else %}
    {# fallback spectateur #}
    {% set selfName  = match.player1.user.pseudo %}
    {% set selfScore = match.score1 %}
    {% set oppName   = match.player2.user.pseudo %}
    {% set oppScore  = match.score2 %}
{% endif %}

<div class="hp-container">

    <div class="player">
        <h3>{{ selfName }}</h3>
        <div class="hearts">
            {% for i in 1..3 %}
                {% if i <= (selfScore ?? 0) %}
                    <span class="heart full">‚ù§Ô∏è</span>
                {% else %}
                    <span class="heart empty">ü§ç</span>
                {% endif %}
            {% endfor %}
        </div>
    </div>

    <div class="hp-vs">VS</div>

    <div class="player">
        <h3>{{ oppName }}</h3>
        <div class="hearts">
            {% for i in 1..3 %}
                {% if i <= (oppScore ?? 0) %}
                    <span class="heart full">‚ù§Ô∏è</span>
                {% else %}
                    <span class="heart empty">ü§ç</span>
                {% endif %}
            {% endfor %}
        </div>
    </div>

</div>




    {# ------------------------------------------------------------- #
       üé¥ PHASE DES CARTES ‚Äî JOUEURS
    # ------------------------------------------------------------- #}

    {% if match.phase == 'cards' %}

        {# Identification joueur #}
        {% set isP1 = currentParticipant and currentParticipant.id == match.player1.id %}
        {% set isP2 = currentParticipant and currentParticipant.id == match.player2.id %}

        {% set readySelf = isP1 ? match.player1Ready : (isP2 ? match.player2Ready : false) %}
        {% set readyOpp  = isP1 ? match.player2Ready : (isP2 ? match.player1Ready : false) %}

        <h2 class="section-title">üé¥ Vos cartes</h2>

        <p class="ready-status">
            Vous : {{ readySelf ? "‚úÖ Pr√™t" : "‚è≥ Pas pr√™t" }} <br>
            Adversaire : {{ readyOpp ? "‚úÖ Pr√™t" : "‚è≥ Pas pr√™t" }}
        </p>


        {# ------------------------------------------------------------- #
           S√©paration des cartes : P1 / P2
        # ------------------------------------------------------------- #}

       {% set p1List = [] %}
{% set p2List = [] %}

{% for c in usedCards %}
    {% if c.player and c.player.id == match.player1.id %}
        {% set p1List = p1List|merge([c]) %}
    {% elseif c.player and c.player.id == match.player2.id %}
        {% set p2List = p2List|merge([c]) %}
    {% endif %}
{% endfor %}

{% if isP1 %}
    {% set myList = p1List %}
    {% set oppList = p2List %}
{% elseif isP2 %}
    {% set myList = p2List %}
    {% set oppList = p1List %}
{% else %}
    {% set myList = [] %}
    {% set oppList = [] %}
{% endif %}
<ul>
    {% for c in usedCards %}
        <li>{{ c.card.name }} ‚Äî usedBy.id = {{ c.usedBy.id }}</li>
    {% endfor %}
    
</ul>

        {# ------------------------------------------------------------- #
           üÉè CARTES JOU√âES ‚Äî 3 slots
        # ------------------------------------------------------------- #}

        <div class="card-zone">

            <div class="cards-side">
                <h3>üÉè Vos cartes jou√©es</h3>
                <div class="card-slots">
                    {% for i in 0..2 %}
                        {% set play = myList[i] ?? null %}
                        {% if play %}
                            <div class="slot card-revealed">
                                <img src="{{ asset('img/cards/' ~ play.card.image) }}" alt="">
                                <p>{{ play.card.name }}</p>
                            </div>
                        {% else %}
                            <div class="slot empty-slot"></div>
                        {% endif %}
                    {% endfor %}
                </div>
            </div>

            <div class="cards-side">
                <h3>üÉè Cartes adverses</h3>
                <div class="card-slots">
                    {% for i in 0..2 %}
                        {% set play = oppList[i] ?? null %}
                        {% if play %}
                            <div class="slot card-hidden">
                                <img src="{{ asset('img/cards/backside.png') }}" alt="">
                            </div>
                        {% else %}
                            <div class="slot empty-slot"></div>
                        {% endif %}
                    {% endfor %}
                </div>
            </div>

        </div>



        {# ------------------------------------------------------------- #
           CARTES DISPONIBLES
        # ------------------------------------------------------------- #}

        <h3 class="section-title">üß© Vos cartes disponibles</h3>

        <div class="card-grid selectable">

            {% set hasCards = false %}

            {% for pc in availableCards %}
                {% if pc.quantity > 0 %}
                    {% set hasCards = true %}
                    <div class="card-item {{ pc.card.type }}">
                        <div class="quantity-badge">x{{ pc.quantity }}</div>
                        <div class="card-image">
                            <img src="{{ asset('img/cards/' ~ pc.card.image) }}" alt="">
                        </div>
                        <h4>{{ pc.card.name }}</h4>

                        <form method="POST"
                              action="{{ path('app_tournament_match_use_card', {
                                  tournamentId: tournament.id,
                                  id: match.id,
                                  cardId: pc.card.id
                              }) }}">
                            <button class="use-card-btn">Utiliser</button>
                        </form>
                    </div>
                {% endif %}
            {% endfor %}

            {% if not hasCards %}
                <p>Aucune carte disponible.</p>
            {% endif %}

        </div>



        {# READY BUTTON #}

        <div class="ready-zone">
            {% if not readySelf %}
                <form method="POST"
                      action="{{ path('app_tournament_match_set_ready', {
                          tournamentId: tournament.id, id: match.id
                      }) }}">
                    <button class="btn btn-success neon-btn">J'ai fini mes cartes</button>
                </form>
            {% else %}
                <form method="POST"
                      action="{{ path('app_tournament_match_cancel_ready', {
                          tournamentId: tournament.id, id: match.id
                      }) }}">
                    <button class="btn-red">‚ùå Annuler pr√™t</button>
                </form>
            {% endif %}
        </div>

    {% endif %}



    {# ------------------------------------------------------------- #
       ‚öîÔ∏è BATTLE
    # ------------------------------------------------------------- #}

    {% if match.phase == 'battle' %}
        <h2 class="section-title">ü™Ñ Cartes r√©v√©l√©es</h2>

        <div class="reveal-wrapper">

            <div class="reveal-column">
                <h3>Vos cartes</h3>
                {% for c in myCards %}
                    <div class="card-item {{ c.card.type }}">
                        <img src="{{ asset('img/cards/' ~ c.card.image) }}">
                        <p>{{ c.card.name }}</p>
                    </div>
                {% endfor %}
            </div>

            <div class="reveal-column">
                <h3>Cartes adverses</h3>
                {% for c in oppCards %}
                    <div class="card-item {{ c.card.type }}">
                        <img src="{{ asset('img/cards/' ~ c.card.image) }}">
                        <p>{{ c.card.name }}</p>
                    </div>
                {% endfor %}
            </div>

        </div>
    {% endif %}



    {# ------------------------------------------------------------- #
       üèÅ VALIDATED
    # ------------------------------------------------------------- #}

    {% if match.phase == 'validated' %}

        <h2 class="section-title">üèÅ Match termin√©</h2>

        <p class="winner-line">
            üèÜ Vainqueur :
            <strong>{{ match.winner.user.pseudo }}</strong>
        </p>

        {# R√©partition P1 / P2 #}
        {% set p1List = [] %}
        {% set p2List = [] %}

        {% for c in usedCards %}
            {% if c.player and c.player.id == match.player1.id %}
                {% set p1List = p1List|merge([c]) %}
            {% elseif c.player and c.player.id == match.player2.id %}
                {% set p2List = p2List|merge([c]) %}
            {% endif %}
        {% endfor %}

        {% if isP1 %}
            {% set myList = p1List %}
            {% set oppList = p2List %}
        {% elseif isP2 %}
            {% set myList = p2List %}
            {% set oppList = p1List %}
        {% else %}
            {% set myList = p1List %}
            {% set oppList = p2List %}
        {% endif %}

        <div class="reveal-wrapper">

            <div class="reveal-column">
                <h3>Vos cartes</h3>
                {% for c in myList %}
                    <div class="card-item {{ c.card.type }}">
                        <img src="{{ asset('img/cards/' ~ c.card.image) }}">
                        <p>{{ c.card.name }}</p>
                    </div>
                {% endfor %}
            </div>

            <div class="reveal-column">
                <h3>Cartes adverses</h3>
                {% for c in oppList %}
                    <div class="card-item {{ c.card.type }}">
                        <img src="{{ asset('img/cards/' ~ c.card.image) }}">
                        <p>{{ c.card.name }}</p>
                    </div>
                {% endfor %}
            </div>

        </div>

    {% endif %}



    {# ------------------------------------------------------------- #
       üìú COMBAT LOG
    # ------------------------------------------------------------- #}

    {% if match.combatLog %}
        <h3>üìú Historique</h3>
        <ul>
            {% for line in match.combatLog %}
                <li>{{ line }}</li>
            {% endfor %}
        </ul>
    {% endif %}

</section>
{% endblock %}
