{% extends 'base.html.twig' %}

{% block body %}
<section class="match-view">

    <h1 class="match-title"> 
        <span>{{ match.player1.user.email }}</span> vs <span>{{ match.player2.user.email }}</span>
    </h1>

    <p class="phase-indicator">
        Phase actuelle : <strong>{{ match.phase|capitalize }}</strong>
    </p>

    {# ------------------------------------------------------------- #
       ğŸ”¥ SCORE / HP
    # ------------------------------------------------------------- #}
    <div class="hp-container">
        <div class="player">
            <h3>{{ match.player1.user.email }}</h3>
            <div class="hearts">
                {% for i in 1..3 %}
                    {% if i <= match.score1 %}
                        <span class="heart full">â¤ï¸</span>
                    {% else %}
                        <span class="heart empty">ğŸ¤</span>
                    {% endif %}
                {% endfor %}
            </div>
        </div>

        <div class="player">
            <h3>{{ match.player2.user.email }}</h3>
            <div class="hp-bar">
                <div class="hp-fill" style="width: {{ match.score2 ?? 0 }}%;"></div>
            </div>
            <p class="hp-text">{{ match.score2 ?? 'HP non dÃ©fini' }}</p>
        </div>
    </div>


    {# ------------------------------------------------------------- #
       ğŸ”¥ğŸ”¥ğŸ”¥ PHASE : CARTES
    # ------------------------------------------------------------- #}
    {% if match.phase == 'cards' %}

        <h2 class="section-title">ğŸ´ Phase des cartes</h2>

        {# ----- STATUT READY ----- #}
        {% set isP1 = (match.player1.user.id == app.user.id) %}
        {% set readySelf = isP1 ? match.player1Ready : match.player2Ready %}
        {% set readyOpp  = isP1 ? match.player2Ready : match.player1Ready %}

        <div class="ready-status">
            <p>ğŸ‘¤ Vous : {{ readySelf ? "âœ… PrÃªt" : "â³ Pas prÃªt" }}</p>
            <p>ğŸ‘¤ Adversaire : {{ readyOpp ? "âœ… PrÃªt" : "â³ Pas prÃªt" }}</p>
        </div>

        {# ----- TES CARTES UTILISÃ‰ES ----- #}
        <div class="cards-phase">
            <div class="my-cards">
                <h3>Vos cartes utilisÃ©es : {{ myCards|length }}</h3>

                {% if myCards is not empty %}
                    <ul>
                        {% for c in myCards %}
                            <li>{{ c.card.name }}</li>
                        {% endfor %}
                    </ul>
                {% else %}
                    <p>Aucune carte utilisÃ©e pour l'instant.</p>
                {% endif %}
            </div>

            {# ----- CARTES ADVERSAIRES : juste le nombre ----- #}
            <div class="opp-cards">
                <h3>Cartes adverses jouÃ©es : {{ oppCardsCount }}</h3>
                <p><em>(Les cartes seront rÃ©vÃ©lÃ©es seulement aprÃ¨s validation de la phase.)</em></p>
            </div>
        </div>


        {# ----- VOS CARTES DISPONIBLES ----- #}
        <h3 class="section-title">ğŸ§© Vos cartes disponibles</h3>

        <div class="available-cards">
            {% if availableCards is empty %}
                <p>Aucune carte disponible.</p>
            {% else %}
                {% for pc in availableCards %}
                    <form method="POST"
                          action="{{ path('app_tournament_match_use_card', {
                              tournamentId: tournament.id,
                              id: match.id,
                              cardId: pc.card.id
                          }) }}"
                          style="display:inline-block">

                        <button class="btn btn-neon small-card-btn">
                            {{ pc.card.name }} (x{{ pc.quantity }})
                        </button>
                    </form>
                {% endfor %}
            {% endif %}
        </div>


        {# ----- READY / CANCEL READY ----- #}
        <div class="ready-zone">
            {% if not readySelf %}
                <form method="POST" action="{{ path('app_tournament_match_set_ready', {
                    tournamentId: tournament.id,
                    id: match.id
                }) }}">
                    <button class="btn btn-success neon-btn">J'ai fini mes cartes</button>
                </form>
            {% else %}
                <form method="POST" action="{{ path('app_tournament_match_cancel_ready', {
                    tournamentId: tournament.id,
                    id: match.id
                }) }}">
                    <button class="btn-red">âŒ Annuler prÃªt</button>
                </form>
            {% endif %}
        </div>

        <p class="info-text">La phase passera automatiquement en Â« battle Â» lorsque les deux joueurs seront prÃªts.</p>

    {% endif %}



    {# ------------------------------------------------------------- #
       ğŸ”¥ğŸ”¥ğŸ”¥ PHASE : BATTLE (RÃ©vÃ©lation des cartes)
    # ------------------------------------------------------------- #}
    {% if match.phase == 'battle' %}

        <h2 class="section-title">ğŸª„ Cartes rÃ©vÃ©lÃ©es</h2>

        {% if usedCards is empty %}
            <p>Aucune carte nâ€™a Ã©tÃ© utilisÃ©e.</p>
        {% else %}
            <ul class="used-card-list">
                {% for c in usedCards %}
                    <li>
                        <strong>{{ c.usedBy.email }}</strong> â†’ {{ c.card.name }}
                    </li>
                {% endfor %}
            </ul>
        {% endif %}

        <p>Le match peut maintenant Ãªtre jouÃ©. L'arbitre saisira ensuite les scores.</p>

    {% endif %}



    {# ------------------------------------------------------------- #
       ğŸ”¥ğŸ”¥ğŸ”¥ PHASE : VALIDATED
    # ------------------------------------------------------------- #}
    {% if match.phase == 'validated' %}

        <h2 class="section-title">ğŸ Match validÃ©</h2>

        <p>Vainqueur : <strong>{{ match.winner.user.email }}</strong></p>

        <h3>Cartes utilisÃ©es :</h3>
        <ul>
            {% for c in usedCards %}
                <li><strong>{{ c.usedBy.email }}</strong> â†’ {{ c.card.name }}</li>
            {% endfor %}
        </ul>

    {% endif %}



    {# ------------------------------------------------------------- #
       ğŸ”¥ğŸ”¥ğŸ”¥ BOUTON VALIDATION ARBITRE (UNIQUEMENT EN BATTLE)
    # ------------------------------------------------------------- #}
    {% if match.phase == 'battle' 
        and (is_granted('ROLE_REFEREE') or match.tournament.referees.contains(app.user))
        and not match.isValidated %}
         {# --- Formulaire pour le referee : saisie des scores --- #}
    {% if is_granted('ROLE_REFEREE') or match.tournament.referees.contains(app.user) %}
        <form method="post" class="score-form">
            <input type="hidden" name="action" value="score">

            <div class="score-inputs">
                <label>{{ match.player1.user.email }} :</label>
                <input type="number" name="score1" min="0" value="{{ match.score1 ?? '' }}">

                <label>{{ match.player2.user.email }} :</label>
                <input type="number" name="score2" min="0" value="{{ match.score2 ?? '' }}">

                <button type="submit" class="btn btn-neon">ğŸ’¾ Enregistrer les scores</button>
            </div>
        </form>
    {% endif %}

        <form method="post" class="validate-form">
            <input type="hidden" name="action" value="validate">
            <button type="submit" class="btn btn-neon">âœ… Valider le match</button>
        </form>
    {% endif %}


    <a href="{{ path('app_tournament_show', { id: tournament.id }) }}" class="btn-back">â† Retour au tournoi</a>

</section>
{% endblock %}

