{% extends 'base.html.twig' %}

{% block body %}
<section class="match-view">
    <h1 class="match-title"> 
        <span>{{ match.player1.userIdentifier }}</span> vs <span>{{ match.player2.userIdentifier }}</span>
    </h1>

    <div class="hp-container">
        <div class="player">
            <h3>{{ match.player1.userIdentifier }}</h3>
            <div class="hp-bar">
                <div class="hp-fill" style="width: {{ match.score1 is not null ? match.score1 : 0 }}%;"></div>
            </div>
            <p class="hp-text">
                {% if match.score1 is not null %}
                    {{ match.score1 }} HP
                {% else %}
                    HP non d√©fini
                {% endif %}
            </p>
        </div>

        <div class="player">
            <h3>{{ match.player2.userIdentifier }}</h3>
            <div class="hp-bar">
                <div class="hp-fill" style="width: {{ match.score2 is not null ? match.score2 : 0 }}%;"></div>
            </div>
            <p class="hp-text">
                {% if match.score2 is not null %}
                    {{ match.score2 }} HP
                {% else %}
                    HP non d√©fini
                {% endif %}
            </p>
        </div>
    </div>

    {# --- Affichage du score + statut du match --- #}
    {% if match.score1 is not null and match.score2 is not null %}
        <div class="match-score neon-text">
            <p>Score : {{ match.score1 }} - {{ match.score2 }}</p>
            {% if match.winner %}
                <p>üèÜ Vainqueur : {{ match.winner.userIdentifier }}</p>
            {% else %}
                <p>‚öîÔ∏è Match en attente de r√©sultat</p>
            {% endif %}
        </div>
    {% else %}
        <p class="match-score neon-text">‚öîÔ∏è Match en attente de r√©sultat</p>
    {% endif %}

    {# --- Formulaire pour le referee : saisie des scores --- #}
    {% if is_granted('ROLE_REFEREE') or match.tournament.referees.contains(app.user) %}
        <form method="post" class="score-form">
            <input type="hidden" name="action" value="score">
            <div class="score-inputs">
                <label>{{ match.player1.userIdentifier }} :</label>
                <input type="number" name="score1" min="0" value="{{ match.score1 ?? '' }}">

                <label>{{ match.player2.userIdentifier }} :</label>
                <input type="number" name="score2" min="0" value="{{ match.score2 ?? '' }}">

                <button type="submit" class="btn btn-neon">üíæ Enregistrer les scores</button>
            </div>
        </form>
    {% endif %}

    <h2 class="section-title">üé¥ Vos cartes disponibles</h2>

    <div class="cards-grid">
        {% if availableCards is not empty %}
            {% for card in availableCards %}
                <div class="match-card">
                    <h4 class="card-name">{{ card.card.name }}</h4>
                    <p class="card-effect">{{ card.card.effect }}</p>
                    <p class="card-quantity">Quantit√© : {{ card.quantity }}</p>

                    <form method="POST" action="{{ path('app_tournament_match_use_card', {
                        tournamentId: tournament.id,
                        id: match.id,
                        cardId: card.card.id
                    }) }}">
                        <input type="hidden" name="_token" value="{{ csrf_token('use_card_' ~ card.id) }}">

                        <button type="submit"
                                class="btn-activate"
                                {% if match.score1 is not null and match.score1 <= 0 or match.score2 is not null and match.score2 <= 0 %}disabled{% endif %}>
                            Activer
                        </button>
                    </form>
                </div>
            {% endfor %}
        {% else %}
            <p class="empty-text">Aucune carte disponible pour vous.</p>
        {% endif %}
    </div>

    <h2 class="section-title">ü™Ñ Cartes utilis√©es pendant le match</h2>

    <div class="used-cards-grid">
        {% if usedCards is not empty %}
            {% for play in usedCards %}
                <div class="used-card">
                    <p class="used-card-name">{{ play.card.name }}</p>
                    <p class="used-card-info">
                        Utilis√©e par 
                        <span class="used-by">
                            {{ play.usedBy.userIdentifier }}
                        </span>
                        √† {{ play.usedAt|date('H:i') }}
                    </p>
                </div>
            {% endfor %}
        {% else %}
            <p class="empty-text">Aucune carte utilis√©e pour le moment.</p>
        {% endif %}
    </div>

    {# --- Validation finale du match (referee only) --- #}
    {% if (is_granted('ROLE_REFEREE') or match.tournament.referees.contains(app.user)) and not match.isValidated %}
        <form method="post" class="validate-form">
            <input type="hidden" name="action" value="validate">
            <button type="submit" class="btn btn-neon">‚úÖ Valider le match</button>
        </form>
    {% endif %}

    <a href="{{ path('app_tournament_show', {id: tournament.id}) }}" class="btn-back">‚Üê Retour au tournoi</a>
</section>
{% endblock %}
