{% extends 'base.html.twig' %}

{% block body %}
<section class="match-view">

{# ------------------------------------- #
   RÃ”LE UTILISATEUR
# ------------------------------------- #}

{# isReferee et currentParticipant viennent DIRECTEMENT du contrÃ´leur #}

{% set isP1 = (not isReferee and currentParticipant and currentParticipant.id == match.player1.id) %}
{% set isP2 = (not isReferee and currentParticipant and currentParticipant.id == match.player2.id) %}

    <h1 class="match-title"> 
        <span>{{ match.player1.user.pseudo }}</span> vs 
        <span>{{ match.player2.user.pseudo }}</span>
    </h1>

    <p class="phase-indicator">
        Phase actuelle : <strong>{{ match.phase|capitalize }}</strong>
    </p>



{# ------------------------------------------------------------- #
   ğŸ”¥ SCORE / HP
# ------------------------------------------------------------- #}

<div class="hp-container">

    <div class="player">
        <h3>{{ match.player1.user.pseudo }}</h3>
        <div class="hearts">
            {% for i in 1..3 %}
                {% if i <= match.score1 %}
                    <span class="heart full">â¤ï¸</span>
                {% else %}
                    <span class="heart empty">ğŸ¤</span>
                {% endif %}
            {% endfor %}
        </div>
    </div>

    <div class="hp-vs">VS</div>

    <div class="player">
        <h3>{{ match.player2.user.pseudo }}</h3>
        <div class="hp-bar">
            <div class="hp-fill" style="width: {{ match.score2 ?? 0 }}%;"></div>
        </div>
        <p class="hp-text">{{ match.score2 ?? 'HP non dÃ©fini' }}</p>
    </div>

</div>




{# ------------------------------------------------------------- #
   ğŸ´ â€” PHASE : CARTES (SLOTS)
# ------------------------------------------------------------- #}

{% if match.phase == 'cards' %}

    {# RÃ©cup readySelf / readyOpp #}
    {% set readySelf = isP1 ? match.player1Ready : (isP2 ? match.player2Ready : false) %}
    {% set readyOpp  = isP1 ? match.player2Ready : (isP2 ? match.player1Ready : false) %}

    {# SÃ©paration cartes pour ARBITRE OU JOUEUR #}
    {% set myList = [] %}
    {% set oppList = [] %}

    {% if isReferee %}
        {% set oppList = usedCards %}
    {% else %}
        {% for c in usedCards %}
            {% if currentParticipant and c.usedBy.id == currentParticipant.user.id %}
                {% set myList = myList|merge([c]) %}
            {% else %}
                {% set oppList = oppList|merge([c]) %}
            {% endif %}
        {% endfor %}
    {% endif %}

    <h2 class="section-title">ğŸ´ Phase des cartes</h2>

    <div class="ready-status">
        <p>ğŸ‘¤ Vous : {{ readySelf ? "âœ… PrÃªt" : "â³ Pas prÃªt" }}</p>
        <p>ğŸ‘¤ Adversaire : {{ readyOpp ? "âœ… PrÃªt" : "â³ Pas prÃªt" }}</p>
    </div>

    <div class="card-zone">

        {# ---------------------- #
           ğŸƒ Mes cartes Ã  moi
        # ---------------------- #}
        <div class="cards-side">
            <h3>ğŸƒ Vos cartes</h3>

            <div class="card-slots">
                {% set myDisplay = isReferee ? [] : myList|slice(0,3) %}

                {% for i in 0..2 %}
                    {% set play = myDisplay[i] ?? null %}

                    {% if play %}
                        <div class="slot card-revealed">
                            <img src="{{ asset('img/cards/' ~ play.card.image) }}" alt="">
                            <p class="card-name">{{ play.card.name }}</p>
                        </div>
                    {% else %}
                        <div class="slot empty-slot"></div>
                    {% endif %}
                {% endfor %}
            </div>
        </div>


        {# --------------------------- #
           ğŸƒ Cartes adverses
        # --------------------------- #}
        <div class="cards-side">
            <h3>ğŸƒ Cartes adverses</h3>

            <div class="card-slots">

                {% set oppDisplay = oppList|slice(0,3) %}

                {% for i in 0..2 %}
                    {% set play = oppDisplay[i] ?? null %}

                    {% if play %}
                        {% if match.phase == 'battle' or match.phase == 'validated' or isReferee %}
                            <div class="slot card-revealed">
                                <img src="{{ asset('img/cards/' ~ play.card.image) }}" alt="">
                                <p class="card-name">{{ play.card.name }}</p>
                            </div>
                        {% else %}
                            <div class="slot card-hidden">
                                <img src="{{ asset('img/cards/backside.png') }}" alt="">
                            </div>
                        {% endif %}
                    {% else %}
                        <div class="slot empty-slot"></div>
                    {% endif %}
                {% endfor %}

            </div>

        </div>

    </div>




    {# ------------------------------------------------------------- #
       ğŸ§© VOS CARTES DISPONIBLES â€” seulement joueur
    # ------------------------------------------------------------- #}

    {% if not isReferee %}
        <h3 class="section-title">ğŸ§© Vos cartes disponibles</h3>

        <div class="card-grid selectable">
            {% if availableCards is empty %}
                <p>Aucune carte disponible.</p>
            {% else %}
                {% for pc in availableCards %}
                    <div class="card-item {{ pc.card.type }}">

                        <div class="quantity-badge">x{{ pc.quantity }}</div>

                        <div class="card-image">
                            <img src="{{ asset('img/cards/' ~ pc.card.image) }}" alt="{{ pc.card.name }}">
                        </div>

                        <div class="card-body">
                            <h4 class="card-title">{{ pc.card.name }}</h4>
                            <p class="card-type">{{ pc.card.type|capitalize }}</p>
                        </div>

                        <form method="POST"
                            action="{{ path('app_tournament_match_use_card', {
                                tournamentId: tournament.id,
                                id: match.id,
                                cardId: pc.card.id
                            }) }}">
                            <button class="use-card-btn">Utiliser</button>
                        </form>

                    </div>
                {% endfor %}
            {% endif %}
        </div>
    {% endif %}


    {# READY #}
    {% if not isReferee %}
        <div class="ready-zone">
            {% if not readySelf %}
                <form method="POST"
                    action="{{ path('app_tournament_match_set_ready', { tournamentId: tournament.id, id: match.id }) }}">
                    <button class="btn btn-success neon-btn">J'ai fini mes cartes</button>
                </form>
            {% else %}
                <form method="POST"
                    action="{{ path('app_tournament_match_cancel_ready', { tournamentId: tournament.id, id: match.id }) }}">
                    <button class="btn-red">âŒ Annuler prÃªt</button>
                </form>
            {% endif %}
        </div>
    {% endif %}

{% endif %}




{# ------------------------------------------------------------- #
   âš”ï¸ BATTLE â€” RÃ©vÃ©lation des cartes
# ------------------------------------------------------------- #}

{% if match.phase == 'battle' %}

    <h2 class="section-title">ğŸª„ Cartes rÃ©vÃ©lÃ©es</h2>

    {% set myList = [] %}
    {% set oppList = [] %}

    {% if isReferee %}
        {% set oppList = usedCards %}
    {% else %}
        {% for c in usedCards %}
            {% if currentParticipant and c.usedBy.id == currentParticipant.user.id %}
                {% set myList = myList|merge([c]) %}
            {% else %}
                {% set oppList = oppList|merge([c]) %}
            {% endif %}
        {% endfor %}
    {% endif %}

    <div class="reveal-wrapper">

        <div class="reveal-column">
            <h3 class="reveal-title">ğŸ´ Vos cartes</h3>

            {% if myList is empty %}
                <p>Aucune carte utilisÃ©e.</p>
            {% else %}
                <div class="card-grid">
                    {% for c in myList %}
                        <div class="card-item {{ c.card.type }}">
                            <div class="card-image">
                                <img src="{{ asset('img/cards/' ~ c.card.image) }}">
                            </div>
                            <h4 class="card-title">{{ c.card.name }}</h4>
                            <p class="card-type">{{ c.card.type|capitalize }}</p>
                        </div>
                    {% endfor %}
                </div>
            {% endif %}
        </div>


        <div class="reveal-column">
            <h3 class="reveal-title">ğŸ´ Cartes adverses</h3>

            {% if oppList is empty %}
                <p>Aucune carte utilisÃ©e.</p>
            {% else %}
                <div class="card-grid">
                    {% for c in oppList %}
                        <div class="card-item {{ c.card.type }}">
                            <div class="card-image">
                                <img src="{{ asset('img/cards/' ~ c.card.image) }}">
                            </div>
                            <h4 class="card-title">{{ c.card.name }}</h4>
                            <p class="card-type">{{ c.card.type|capitalize }}</p>
                        </div>
                    {% endfor %}
                </div>
            {% endif %}
        </div>

    </div>

{% endif %}




{# ------------------------------------------------------------- #
   ğŸ MATCH VALIDÃ‰
# ------------------------------------------------------------- #}

{% if match.phase == 'validated' %}

    <h2 class="section-title">ğŸ Match validÃ©</h2>

    <p class="winner-line">
        ğŸ† Vainqueur :
        <strong class="winner-name">{{ match.winner.user.pseudo }}</strong>
    </p>

    {% set myList = [] %}
    {% set oppList = [] %}

    {% if isReferee %}
        {% set oppList = usedCards %}
    {% else %}
        {% for c in usedCards %}
            {% if currentParticipant and c.usedBy.id == currentParticipant.user.id %}
                {% set myList = myList|merge([c]) %}
            {% else %}
                {% set oppList = oppList|merge([c]) %}
            {% endif %}
        {% endfor %}
    {% endif %}

    <div class="reveal-wrapper">

        <div class="reveal-column">
            <h3 class="reveal-title">ğŸƒ Vos cartes</h3>

            {% if myList is empty %}
                <p>Aucune carte jouÃ©e.</p>
            {% else %}
                <div class="card-grid">
                    {% for c in myList %}
                        <div class="card-item {{ c.card.type }}">
                            <div class="card-image">
                                <img src="{{ asset('img/cards/' ~ c.card.image) }}">
                            </div>
                            <h4 class="card-title">{{ c.card.name }}</h4>
                            <p class="card-type">{{ c.card.type|capitalize }}</p>
                        </div>
                    {% endfor %}
                </div>
            {% endif %}
        </div>


        <div class="reveal-column">
            <h3 class="reveal-title">ğŸƒ Cartes adverses</h3>

            {% if oppList is empty %}
                <p>Aucune carte jouÃ©e.</p>
            {% else %}
                <div class="card-grid">
                    {% for c in oppList %}
                        <div class="card-item {{ c.card.type }}">
                            <div class="card-image">
                                <img src="{{ asset('img/cards/' ~ c.card.image) }}">
                            </div>
                            <h4 class="card-title">{{ c.card.name }}</h4>
                            <p class="card-type">{{ c.card.type|capitalize }}</p>
                        </div>
                    {% endfor %}
                </div>
            {% endif %}
        </div>

    </div>

{% endif %}





{# ------------------------------------------------------------- #
   ğŸ“œ HISTORIQUE DU COMBAT
# ------------------------------------------------------------- #}

{% if match.combatLog is not empty %}
    <div class="combat-log">
        <h3>ğŸ“œ Historique du combat</h3>
        <ul>
            {% for line in match.combatLog %}
                <li>{{ line }}</li>
            {% endfor %}
        </ul>
    </div>
{% endif %}




{# ------------------------------------------------------------- #
   âš–ï¸ SECTION ARBITRE
# ------------------------------------------------------------- #}

{% if match.phase == 'battle'
      and isReferee
      and not match.isValidated %}

    <div class="referee-zone">

        <h3>âš–ï¸ Validation du match</h3>

        <form method="post" class="score-form">
            <input type="hidden" name="action" value="score">

            <div class="score-inputs">
                <label>{{ match.player1.user.pseudo }} :</label>
                <input type="number" name="score1" min="0" value="{{ match.score1 ?? '' }}">

                <label>{{ match.player2.user.pseudo }} :</label>
                <input type="number" name="score2" min="0" value="{{ match.score2 ?? '' }}">

                <button class="btn btn-neon">ğŸ’¾ Enregistrer les scores</button>
            </div>
        </form>

        <form method="post" class="validate-form">
            <input type="hidden" name="action" value="validate">
            <button type="submit" class="btn btn-neon">âœ… Valider le match</button>
        </form>

    </div>

{% endif %}


</section>
{% endblock %}
